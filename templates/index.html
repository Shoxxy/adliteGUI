<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuStoolz | Dashboard</title>
    <style>
        :root {
            /* NEUES FARBSCHEMA: TOXIC GREEN / BIOHAZARD THEME */
            --bg-core: #0a0c00; /* Sehr dunkles Grüngeschwärz */
            --bg-dark: #111405; 
            --glass: rgba(20, 35, 10, 0.85); /* Dunkelgrünes Glas */
            --border: rgba(173, 255, 47, 0.25); /* Giftgrüner Rand (GreenYellow) */
            --accent: #adff2f; /* Knalliges Giftgrün als Akzent */
            --accent-glow: rgba(173, 255, 47, 0.6);
            --text-main: #e8ffe8; /* Helles Grünweiß */
            --text-dim: #8a9a7a;
            --neon-green: #39ff14; /* Neon für Logs */
            --danger: #ff3300;
        }

        body {
            background-color: var(--bg-core);
            /* Subtiler grüner Schein im Hintergrund */
            background-image: radial-gradient(circle at 50% -20%, rgba(57, 255, 20, 0.15) 0%, var(--bg-core) 70%);
            color: var(--text-main);
            font-family: 'Inter', system-ui, sans-serif;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        /* --- BANNER AREA --- */
        .top-container {
            width: 100%;
            max-width: 1200px;
            margin-bottom: 15px;
        }

        .banner-img {
            width: 100%;
            height: auto; /* Automatische Größenanpassung */
            display: block;
            border-radius: 12px 12px 0 0; /* Oben abgerundet */
            border: 1px solid var(--border);
            border-bottom: none;
            box-shadow: 0 -5px 30px var(--accent-glow);
        }

        /* --- NAVIGATION --- */
        .main-nav {
            display: flex;
            background: var(--glass);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 12px 12px; /* Unten abgerundet */
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            align-items: center;
        }

        .nav-link {
            text-decoration: none;
            color: var(--text-dim);
            font-weight: 700;
            padding: 10px 20px;
            border-radius: 6px;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
            margin-right: 10px;
        }
        
        /* Aktiver Link leuchtet */
        .nav-link.active, .nav-link:hover {
            color: var(--bg-core);
            background: var(--accent);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .user-badge { margin-left: auto; font-size: 0.9rem; color: var(--text-dim); display: flex; align-items: center; }
        .logout { color: var(--danger); text-decoration: none; margin-left: 15px; font-weight: bold; padding: 5px 10px; border: 1px solid rgba(255, 51, 0, 0.3); border-radius: 4px;}
        .logout:hover { background: rgba(255, 51, 0, 0.2); }

        /* --- MAIN GRID LAYOUT --- */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1.3fr;
            gap: 20px;
            width: 100%;
            max-width: 1200px;
            /* Höhe anpassen, damit es trotz Banner auf den Screen passt */
            height: calc(80vh - 100px); 
            min-height: 600px;
        }

        /* PANELS */
        .panel {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            overflow-y: auto;
            position: relative;
        }
        
        /* Title Update */
        h1.panel-title { 
            margin: 0 0 20px 0; 
            font-size: 1.8rem; 
            color: var(--accent); 
            letter-spacing: 1px; 
            text-transform: uppercase; 
            text-shadow: 0 0 10px var(--accent-glow);
        }
        
        .edition-tag {
            font-size: 0.7rem;
            color: var(--text-dim);
            vertical-align: middle;
            margin-left: 10px;
            letter-spacing: 0;
            text-transform: none;
            background: rgba(173, 255, 47, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        /* FORM ELEMENTS - Toxic Style */
        label { color: var(--accent); letter-spacing: 1px; font-size: 0.7rem; margin-top: 15px; }
        input, select { background: rgba(0,0,0,0.6); border-color: var(--border); color: var(--accent); }
        input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }

        /* MODE SWITCHER - Green */
        .mode-btn { background: #0a1000; border-color: var(--border); color: var(--text-dim); }
        .mode-btn.active { background: var(--accent); color: var(--bg-core); box-shadow: 0 0 20px var(--accent-glow); border-color: var(--accent); }

        /* BUTTON - Changed Text */
        #executeBtn {
            margin-top: auto;
            background: linear-gradient(135deg, var(--accent), #7cb300);
            color: var(--bg-core);
            font-size: 1.1rem;
            box-shadow: 0 0 20px rgba(173, 255, 47, 0.4);
        }
        #executeBtn:hover { transform: translateY(-2px); box-shadow: 0 0 30px var(--accent-glow); }

        /* LOG WINDOW - Matrix Style Green */
        #log-window { background: #050800; border-color: var(--border); color: var(--neon-green); }
        .log-entry { border-bottom-color: #1a2505; }
        .log-ts { color: #557722; }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="top-container">
        <img src="/static/banner.png" alt="SusToolZ Banner" class="banner-img">
        
        <nav class="main-nav">
            <a href="/" class="nav-link {% if current_page == 'home' %}active{% endif %}">Dashboard</a>
            <a href="/repeat" class="nav-link {% if current_page == 'repeat' %}active{% endif %}">Empfohlen Repeat</a>
            
            <div class="user-badge">
                 Operator: <span style="color:var(--accent); margin-left:5px;">{{ user }}</span> 
                 <a href="/logout" class="logout">ABMELDEN</a>
            </div>
        </nav>
    </div>

    <div class="main-grid">
        <div class="panel">
            <h1 class="panel-title">
                SusToolZ 
                <span class="edition-tag">(Empfohlen Edition xd)</span>
            </h1>

            <label style="margin-top:0;">OPERATION MODE</label>
            <div class="mode-toggles">
                <button type="button" class="mode-btn active" onclick="setMode('single')">SINGLE</button>
                <button type="button" class="mode-btn" onclick="setMode('credit_all')">CREDIT ALL</button>
                <button type="button" class="mode-btn" onclick="setMode('timer')">TIMER</button>
            </div>

            <form id="controlForm">
                <input type="hidden" name="mode" id="modeInput" value="single">

                <label>APP SELECTION</label>
                <select name="app_name" id="appSelect" onchange="updateEvents()">
                    {% for app_name in app_config.keys() %}
                    <option value="{{ app_name }}">{{ app_name }}</option>
                    {% endfor %}
                </select>

                <label>PLATFORM</label>
                <select name="platform">
                    <option value="android">ANDROID (GAID)</option>
                    <option value="ios">IOS (IDFA)</option>
                </select>

                <label>DEVICE ID</label>
                <input type="text" name="device_id" placeholder="xxxx-xxxx-xxxx-xxxx" required>

                <div id="singleParams">
                    <label>EVENT TRIGGER</label>
                    <select name="event_name" id="eventSelect"></select>
                </div>

                <div id="timerParams" class="hidden">
                     <label>START TERMIN (Optional)</label>
                     <input type="datetime-local" name="start_time" id="startTimeInput" style="color-scheme: dark;">
                     <div style="margin-top:5px; margin-bottom:15px; font-size:0.7rem; color:var(--text-dim);">
                         Leer lassen = Sofort starten.
                     </div>
 
                    <label>MIN DELAY (HOURS)</label>
                    <input type="number" name="delay_min" step="0.1" value="1.0">
                    <label>MAX DELAY (HOURS)</label>
                    <input type="number" name="delay_max" step="0.1" value="5.0">
                    <div style="margin-top:10px; font-size:0.7rem; color:var(--text-dim);">
                        Random Intervall zwischen Events.
                    </div>
                </div>

                <div id="allParams" class="hidden" style="margin-top:15px; font-size:0.75rem; color:var(--accent);">
                    ⚠ Führt ALLE Events dieser App sequentiell aus.
                </div>

                <button type="submit" id="executeBtn">Credit Event</button>
            </form>
        </div>

        <div class="panel" style="padding:0; border:none; background:transparent; box-shadow:none;">
            <div class="panel" style="height:100%; padding-bottom:10px;">
                <h1 class="panel-title" style="font-size:1.2rem;">Live Uplink</h1>
                <div id="log-window">
                    <div class="log-entry"><span class="log-ts">SYS</span> SusToolZ "Empfohlen Edition" initialized.</div>
                    <div class="log-entry"><span class="log-ts">SYS</span> Awaiting inputs...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const appConfig = {{ app_config | tojson }};
        
        function setMode(mode) {
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('modeInput').value = mode;
            document.getElementById('singleParams').classList.toggle('hidden', mode !== 'single');
            document.getElementById('timerParams').classList.toggle('hidden', mode !== 'timer');
            document.getElementById('allParams').classList.toggle('hidden', mode !== 'credit_all');
        }

        function updateEvents() {
            const appName = document.getElementById('appSelect').value;
            const eventSelect = document.getElementById('eventSelect');
            eventSelect.innerHTML = '';
            if(appConfig[appName]) {
                appConfig[appName].forEach(evt => {
                    let opt = document.createElement('option');
                    opt.value = evt; opt.text = evt; eventSelect.appendChild(opt);
                });
            }
        }
        updateEvents();

        document.getElementById('controlForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('executeBtn');
            const logWin = document.getElementById('log-window');
            
            // Coole Animation beim Klicken
            btn.innerHTML = "Processing...";
            btn.style.background = "#333"; btn.style.color = "var(--accent)";
            btn.disabled = true;

            const formData = new FormData(e.target);

            const tempLog = document.createElement('div');
            tempLog.className = 'log-entry';
            tempLog.innerHTML = `<span class="log-ts" style="color:var(--accent);">CMD</span> Transmitting to Zone B...`;
            logWin.appendChild(tempLog);
            logWin.scrollTop = logWin.scrollHeight;

            try {
                const res = await fetch('/api/proxy_send', { method: 'POST', body: formData });
                const data = await res.json();

                const newEntry = document.createElement('div');
                newEntry.className = 'log-entry';
                // Farben anpassen ans neue Theme
                newEntry.style.color = data.success ? "var(--neon-green)" : "var(--danger)";
                newEntry.innerHTML = data.log_entry || "<span class='log-ts'>ERR</span> Unknown Server Response";
                
                logWin.appendChild(newEntry);

            } catch (err) {
                const errEntry = document.createElement('div');
                errEntry.className = 'log-entry';
                errEntry.style.color = "var(--danger)";
                errEntry.innerHTML = "<span class='log-ts'>CRIT</span> Uplink failed. " + err;
                logWin.appendChild(errEntry);
            } finally {
                // Button zurücksetzen
                btn.innerHTML = "Credit Event";
                btn.removeAttribute("style"); // Reset inline styles to CSS defaults
                btn.disabled = false;
                logWin.scrollTop = logWin.scrollHeight;
            }
        };
    </script>
</body>
</html>